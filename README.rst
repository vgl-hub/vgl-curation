================================
Process Curated Genome Assembly
================================

ProcessCurated is a set of tools to process curated genome assemblies. In combination with gfastats and mashmap, tt reconciliate the AGP file manually curated in PretextView to rename, reorient, and sort the assemblies to get them ready for submission. 




Install
=======

Prerequisites::

    python>=3.9
    setuptools


Download the release archive or clone the github repository. Install with pip from the main directory::

    pip install ./



Tools usage
===========


Available tools:

* AGPCorrect : Correcting AGP for sequence lengths

* hap_split: Splitting the haplotypes from the corrected AGP

* unloc: Assigning unlocs before the agp is imposed on the fasta and remove haplotig duplications from their origin haplotype

* chromosome_assignment: Substituting scaffold for chromosome assignments

* sak_generation: Processing Mashmap output for reorientation and renaming of scaffolds in haplotype 2.



AGPCorrect
-----------

Inputs:

* Fasta file of the Assembly with the two haplotypes

* Curated AGP generated with PretextView (See manual in `docs` for curation tips)


Usage::

    AGPcorrect assembly.fasta curated.agp > corrected.agp 

Output:

* Corrected AGP file


hap_split
----------

Inputs:

* Corrected AGP file (-a)

* Output AGP file for Haplotype 1 (-1) 

* Output AGP file for Haplotype 2 (-2) 


Usage::

    hap_split -a corrected.agp -1 Hap_1/hap1.agp -2 Hap_2/hap2.agp 


Output:

* AGP file for each haplotype



unloc
-----

Inputs:
 
* AGP file or one haplotype (-a)

* Output directory (-o)

Usage::

    unloc -a Hap_1/hap1.agp -o Hap_1


Output:

* An agp file with the unloc assigned and the duplicated haplotigs removed. (<outdir>/hap.unlocs.no_hapdups.agp)

* Removed haplotigs (<outdir>/haplotigs.agp)


chromosome_assignment
---------------------

Inputs:

* AGP file with the unloc assigned (-a)

* Sorted fasta file for the haplotype (-f)

* Output directory (-o)


Usage::

    chromosome_assignment -a Hap_1/hap.unlocs.no_hapdups.agp -f Hap_1/hap.sorted.fa -o Hap_1 


Output:

* Table mapping the scaffolds to their chromosomal assignment (<output_dir>/inter_chr.tsv)

* Fasta file with chromosomal level sequences (<output_dir>/hap.chr_level.fa)


sak_generation
--------------

Inputs:

* Table mapping the scaffolds to their chromosomal assignment for haplotype 1 (-1) and haplotype 2 (-2)

* Output of the mashmap alignement of the two haplotypes (-m) 

* Haplotype used as a query in Mashmap (-q). Possible values (Hap_1 or Hap_2)

* Haplotype used as a reference in Mashmap (-q). Possible values (Hap_1 or Hap_2)

* Corrected AGP output of *AGPCorrect* (-a)

* Sex chromosome specific to heterogametic individuals in the species (-s). Example: Y for human, W for birds.

* Output directory (-o)

Usage::

    filter_mashmap_with_tagged_pairs -1 Hap_1/inter_chr.tsv -2 Hap_2/inter_chr.tsv -m mashmap.out -q Hap_2 -r Hap_1 -a corrected.agp  -s W -o results/ 


Output:

* SAK file for gfastats reversing and renaming of Haplotype 2 sequences (<out_dir>/rvcp.sak) 

* Table with the orientation of Hap1 vs Hap2 scaffolds (The sign is the most represented in the mashmap alignments between two sequences) (<out_dir>/orientation.tsv)  

* The Mapping between hap2 and hap1 names (<out_dir>/hap2.vs.hap1.tsv) 


Run whole analysis
==================

Extra dependencies : 

* gfastats>=1.3.10

* MashMap


Inputs: 

* Fasta file with the 2 haplotypes (<fasta>)

* AGP file generated by PretextView after manual curation (see README.md for curation tips)  (<agp>)

* Sex chromosome specific to heterogametic individuals in the species. Example: Y for human, W for birds. (<Heterogametic chromosome>)



Split AGP and assign unlocs::

    AGPcorrect <fasta> <agp> > corrected.agp 

    hap_split  -1 Hap_1/hap1.agp -2 Hap_2/hap2.agp -a corrected.agp   

    unloc -a Hap_1/hap1.agp -o Hap_1
    unloc -a Hap_2/hap2.agp -o Hap_2


Run gfastats to reconciliate the curated agp with the fasta file for each haplotype and sort them by size::

    gfastats <fasta> --agp-to-path Hap_1/hap.unlocs.no_hapdups.agp -o Hap_1/hap.unlocs.no_hapdups.fa
    gfastats Hap_1/hap.unlocs.no_hapdups.fa --sort largest -o Hap_1/hap.sorted.fa 

    gfastats <fasta> --agp-to-path Hap_2/hap.unlocs.no_hapdups.agp -o Hap_2/hap.unlocs.no_hapdups.fa 
    gfastats Hap_2/hap.unlocs.no_hapdups.fa --sort largest -o Hap_2/hap.sorted.fa 


Assign chromosome names to scaffolds::

    chromosome_assignment -a Hap_1/hap.unlocs.no_hapdups.agp -f Hap_1/hap.sorted.fa -o Hap_1 
    chromosome_assignment -a Hap_2/hap.unlocs.no_hapdups.agp -f Hap_2/hap.sorted.fa -o Hap_2 


Align haplotype 1 versus haplotype 2 with MashMap to detect mis-orientations::

    mashmap -r Hap_1/hap.chr_level.fa  -q Hap_2/hap.chr_level.fa -f one-to-one -t 16 -s 50000 --pi 90 -o mashmap_original_fastas.out


Rename and reorient the haplotype 2 sequences to match the haplotype 1::

    awk '/^>/ {$1 = $1 "_oldname"} {print}' Hap_2/hap.chr_level.fa > Hap_2/tmpnamed.fa # Add temporary suffix to avoid confusion between old and new names during the renaming.
    sak_generation  -1 Hap_1/inter_chr.tsv -2 Hap_2/inter_chr.tsv -r Hap_1 -q Hap_2 -a corrected.agp -m  mashmap_original_fastas.out -s <Heterogametic chromosome> -o tagged_pairs/ 
    gfastats Hap_2/tmpnamed.fa  -k tagged_pairs/reversing_renaming.sak  -o Hap_2/hap2.partially_renamed.fasta 
    sed '/^>/ s/_oldname//' Hap_2/hap2.partially_renamed.fasta >  Hap_2/hap2.reoriented.renamed.fasta  # Remove temporary suffix.



Use the script
--------------

You can use the curation_2.0_pipe.sh script to run the whole workflow. 

Extra dependencies : 

* gfastats>=1.3.10

* MashMap


Inputs and options : 

* -f Pass original fasta file with combined haplotypes.  (Required)

* -a Pass the agp generated by PretextView.  (Required)

* -s Sexual Chromosome marking the heterogametic individuals(e.g. 'Y' for humans, 'W' for birds). (Required)

* -d Test dependencies and install if missing (need conda). (Optional) (Note: This option may fail if you are in a python venv)


Usage::

    sh bin/curation_2.0_pipe.sh -f <fasta> -a <agp> -s <Heterogametic chromosome> -d


Additional outputs:



* Log File for the hole analysis (logs/std.agp_to_path_hap1.<Run Number>.out)
* Log/Error File for Hap_2 reconciliation" (logs/std.agp_to_path_hap2..<Run Number>.out)
* Log/Error File for Hap_1 reconciliation" l(ogs/std.agp_to_path_hap1..<Run Number>.out)
* Log/Error File for Mashmap" (logs/std.mashmap.<Run Number>.out)



Contributors
============

- Nadoline Brajuka
- Delphine Lariviere
- Eric Duarte
- Kirsty McCaffrey
- Giulio Formenti